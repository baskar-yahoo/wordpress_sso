# Webtrees Root .htaccess for Windows Development (XAMPP)
# WordPress SSO Integration - Cache Bypass Configuration
# Development Environment: http://localhost/svajana/familytree

# BEGIN LiteSpeed/Apache Cache Bypass for Authenticated Users
<IfModule LiteSpeed>
    # LiteSpeed-specific cache control
    CacheLookup on
    RewriteEngine On
    
    # Bypass LiteSpeed cache when WordPress authentication cookie is present
    # This ensures WordPress-authenticated users get fresh content
    RewriteCond %{HTTP_COOKIE} wordpress_logged_in_ [NC]
    RewriteRule .* - [E=Cache-Control:no-cache,E=no-cache:1]
    
    # Also bypass cache for Webtrees-authenticated users
    # Webtrees uses PHP session cookies (PHPSESSID or custom session name)
    RewriteCond %{HTTP_COOKIE} PHPSESSID [NC]
    RewriteRule .* - [E=Cache-Control:no-cache,E=no-cache:1]
</IfModule>

# For Apache without LiteSpeed (XAMPP default)
<IfModule !LiteSpeed>
    # Enable rewrite engine for cache bypass
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Set environment variables for header module
        RewriteCond %{HTTP_COOKIE} wordpress_logged_in_ [NC]
        RewriteRule .* - [E=WP_AUTH:1]
        
        RewriteCond %{HTTP_COOKIE} PHPSESSID [NC]
        RewriteRule .* - [E=WT_AUTH:1]
    </IfModule>
</IfModule>
# END LiteSpeed/Apache Cache Bypass

# BEGIN Cache Headers for Authenticated Users
<IfModule mod_headers.c>
    # Detect WordPress authentication cookie
    SetEnvIf Cookie "wordpress_logged_in_" wp_user_authenticated
    
    # Detect Webtrees session cookie (PHP session)
    SetEnvIf Cookie "PHPSESSID" wt_user_authenticated
    
    # Set strict no-cache headers for WordPress authenticated users
    # Prevents browser and proxy caching of authenticated content
    Header always set Cache-Control "no-cache, no-store, must-revalidate" env=wp_user_authenticated
    Header always set Pragma "no-cache" env=wp_user_authenticated
    Header always set Expires "0" env=wp_user_authenticated
    
    # Set strict no-cache headers for Webtrees authenticated users
    Header always set Cache-Control "no-cache, no-store, must-revalidate" env=wt_user_authenticated
    Header always set Pragma "no-cache" env=wt_user_authenticated
    Header always set Expires "0" env=wt_user_authenticated
</IfModule>
# END Cache Headers

# BEGIN Webtrees URL Rewriting
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /svajana/familytree/
    
    # Allow direct access to existing files and directories
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # Route all other requests through index.php
    RewriteRule . /svajana/familytree/index.php [L]
</IfModule>
# END Webtrees URL Rewriting

# Security: Disable directory browsing
Options -Indexes

# Security: Protect sensitive files in Webtrees root
<FilesMatch "^(config\.ini\.php|\.git|\.env|composer\.(json|lock))$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Note: The data/ folder has its own .htaccess that blocks all access
# This is maintained by Webtrees core and should NOT be modified
# Location: C:\xampp\htdocs\svajana\familytree\data\.htaccess contains "Deny from all"
# Your root .htaccess does NOT override data/.htaccess (Apache hierarchy)
