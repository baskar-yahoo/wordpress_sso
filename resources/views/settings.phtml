<?php

use Fisharebest\Webtrees\I18N;

/** @var \Fisharebest\Webtrees\View $this */

$disabled_attr = $config_location === 'config.ini.php' ? 'disabled' : '';

?>

<div class="card">
    <div class="card-header"><?= I18N::translate('WordPress SSO Settings') ?></div>
    <div class="card-body">
        
        <?php if ($config_location === 'config.ini.php'): ?>
        <div class="alert alert-info">
            <strong><?= I18N::translate('Configuration Source:') ?></strong> config.ini.php
            <br>
            <small><?= I18N::translate('Settings are loaded from config.ini.php. The fields below are locked because file-based configuration takes precedence over database settings.') ?></small>
        </div>
        <?php else: ?>
        <div class="alert alert-warning">
            <strong><?= I18N::translate('Configuration Source:') ?></strong> Database
            <br>
            <small><?= I18N::translate('For version-controlled configuration, add settings to config.ini.php. See README.md for details.') ?></small>
        </div>
        <?php endif; ?>

        <form action="<?= $action_url ?>" method="post">
            <?= csrf_field() ?>
            
            <h4><?= I18N::translate('Basic Settings') ?></h4>
            
            <div class="form-group row">
                <label class="col-sm-3 col-form-label"><?= I18N::translate('Enable Seamless SSO') ?></label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sso_enabled" name="sso_enabled" value="1" <?= $sso_enabled ? 'checked' : '' ?> <?= $disabled_attr ?>>
                        <label class="form-check-label" for="sso_enabled"><?= I18N::translate('Redirect all unauthenticated users to WordPress for login.') ?></label>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label"><?= I18N::translate('Allow New User Creation') ?></label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sso_allow_creation" name="sso_allow_creation" value="1" <?= $sso_allow_creation ? 'checked' : '' ?> <?= $disabled_attr ?>>
                        <label class="form-check-label" for="sso_allow_creation"><?= I18N::translate('Automatically create new user accounts for first-time SSO logins. New accounts will require admin approval.') ?></label>
                    </div>
                </div>
            </div>

            <hr>
            <h4><?= I18N::translate('OAuth2 Provider Settings') ?></h4>

            <div class="form-group row">
                <label for="sso_client_id" class="col-sm-3 col-form-label"><?= I18N::translate('Client ID') ?></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="sso_client_id" name="sso_client_id" value="<?= e($sso_client_id) ?>" <?= $disabled_attr ?>>
                </div>
            </div>

            <div class="form-group row">
                <label for="sso_client_secret" class="col-sm-3 col-form-label"><?= I18N::translate('Client Secret') ?></label>
                <div class="col-sm-9">
                    <input type="password" class="form-control" id="sso_client_secret" name="sso_client_secret" value="<?= e($sso_client_secret) ?>" <?= $disabled_attr ?>>
                </div>
            </div>

            <div class="form-group row">
                <label for="sso_url_authorize" class="col-sm-3 col-form-label"><?= I18N::translate('Authorization URL') ?></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="sso_url_authorize" name="sso_url_authorize" value="<?= e($sso_url_authorize) ?>" <?= $disabled_attr ?>>
                    <small class="form-text text-muted">Example: https://your-site.com/oauth/authorize</small>
                </div>
            </div>

            <div class="form-group row">
                <label for="sso_url_access_token" class="col-sm-3 col-form-label"><?= I18N::translate('Access Token URL') ?></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="sso_url_access_token" name="sso_url_access_token" value="<?= e($sso_url_access_token) ?>" <?= $disabled_attr ?>>
                    <small class="form-text text-muted">Example: https://your-site.com/oauth/token</small>
                </div>
            </div>

            <div class="form-group row">
                <label for="sso_url_resource_owner_details" class="col-sm-3 col-form-label"><?= I18N::translate('Resource Owner Details URL') ?></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="sso_url_resource_owner_details" name="sso_url_resource_owner_details" value="<?= e($sso_url_resource_owner_details) ?>" <?= $disabled_attr ?>>
                    <small class="form-text text-muted">Example: https://your-site.com/oauth/me</small>
                </div>
            </div>

            <div class="form-group row">
                <label for="sso_url_logout" class="col-sm-3 col-form-label"><?= I18N::translate('Logout URL') ?></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="sso_url_logout" name="sso_url_logout" value="<?= e($sso_url_logout) ?>" <?= $disabled_attr ?>>
                    <small class="form-text text-muted"><?= I18N::translate('The URL to redirect to for Single Log-Out.') ?> Example: https://your-site.com/wp-login.php?action=logout</small>
                </div>
            </div>

            <hr>
            <h4><?= I18N::translate('Security Settings') ?></h4>

            <div class="form-group row">
                <label for="sso_pkce_method" class="col-sm-3 col-form-label"><?= I18N::translate('PKCE Method') ?></label>
                <div class="col-sm-9">
                    <select class="form-control" id="sso_pkce_method" name="sso_pkce_method" <?= $disabled_attr ?>>
                        <option value="S256" <?= $sso_pkce_method === 'S256' ? 'selected' : '' ?>>S256 (Recommended)</option>
                        <option value="plain" <?= $sso_pkce_method === 'plain' ? 'selected' : '' ?>>Plain</option>
                        <option value="" <?= $sso_pkce_method === '' ? 'selected' : '' ?>>Disabled</option>
                    </select>
                    <small class="form-text text-muted"><?= I18N::translate('PKCE (Proof Key for Code Exchange) adds extra security to OAuth2 flow. S256 is recommended.') ?></small>
                </div>
            </div>

            <hr>
            <h4><?= I18N::translate('Feature Settings') ?></h4>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label"><?= I18N::translate('Sync Email from WordPress') ?></label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sso_sync_email" name="sso_sync_email" value="1" <?= $sso_sync_email ? 'checked' : '' ?> <?= $disabled_attr ?>>
                        <label class="form-check-label" for="sso_sync_email"><?= I18N::translate('Update user email from WordPress on each login.') ?></label>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label"><?= I18N::translate('Debug Logging') ?></label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sso_debug_enabled" name="sso_debug_enabled" value="1" <?= $sso_debug_enabled ? 'checked' : '' ?> <?= $disabled_attr ?>>
                        <label class="form-check-label" for="sso_debug_enabled"><?= I18N::translate('Enable detailed debug logging (for troubleshooting only).') ?></label>
                    </div>
                    <small class="form-text text-muted"><?= I18N::translate('Debug logs will appear in Control Panel â†’ Website logs. Disable in production for performance.') ?></small>
                </div>
            </div>

            <hr>
            <h4><?= I18N::translate('Integration Information') ?></h4>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label"><?= I18N::translate('Callback URL') ?></label>
                <div class="col-sm-9">
                    <input type="text" readonly class="form-control-plaintext" value="<?= e($callback_url) ?>" id="callback_url_field">
                    <small class="form-text text-muted"><?= I18N::translate('Use this as the Redirect URI in your WordPress OAuth2 Server settings.') ?></small>
                    <button type="button" class="btn btn-sm btn-info mt-2" onclick="copyToClipboard()"><?= I18N::translate('Copy to Clipboard') ?></button>
                </div>
            </div>
            
            <?php if ($sso_debug_enabled): ?>
            <div class="alert alert-warning mt-3">
                <h5><?= I18N::translate('Debug Information') ?></h5>
                <table class="table table-sm">
                    <tr>
                        <th><?= I18N::translate('Callback URL (Plain)') ?>:</th>
                        <td><code><?= e($callback_url_raw) ?></code></td>
                    </tr>
                    <tr>
                        <th><?= I18N::translate('URL Encoded') ?>:</th>
                        <td><code><?= e($callback_url_encoded) ?></code></td>
                    </tr>
                    <tr>
                        <th><?= I18N::translate('Length') ?>:</th>
                        <td><?= strlen($callback_url) ?> characters</td>
                    </tr>
                    <tr>
                        <th><?= I18N::translate('Has trailing slash?') ?>:</th>
                        <td><?= substr($callback_url, -1) === '/' ? 'YES' : 'NO' ?></td>
                    </tr>
                </table>
                <p><strong><?= I18N::translate('Important:') ?></strong> <?= I18N::translate('The redirect URI in WordPress must match EXACTLY (case-sensitive, no extra spaces or characters).') ?></p>
            </div>
            <?php endif; ?>

            <div class="form-group row">
                <div class="offset-sm-3 col-sm-9">
                    <?php if ($disabled_attr): ?>
                        <button type="button" class="btn btn-secondary" disabled><?= I18N::translate('Managed in config.ini.php') ?></button>
                        <small class="d-block mt-2 text-muted"><?= I18N::translate('To edit settings, update the config.ini.php file directly.') ?></small>
                    <?php else: ?>
                        <button type="submit" class="btn btn-primary"><?= I18N::translate('Save') ?></button>
                    <?php endif; ?>
                    <a href="<?= e($callback_url) ?>" class="btn btn-secondary" target="_blank"><?= I18N::translate('Test OAuth Flow') ?></a>
                </div>
            </div>
            
            <script>
            function copyToClipboard() {
                var copyText = document.getElementById("callback_url_field");
                copyText.select();
                copyText.setSelectionRange(0, 99999);
                document.execCommand("copy");
                alert("Copied: " + copyText.value);
            }
            </script>
        </form>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header"><?= I18N::translate('Quick Start Guide') ?></div>
    <div class="card-body">
        <ol>
            <li><?= I18N::translate('Install and configure the WordPress OAuth2 Server plugin') ?></li>
            <li><?= I18N::translate('Create a new OAuth2 client in WordPress with the Callback URL shown above') ?></li>
            <li><?= I18N::translate('Copy the Client ID and Client Secret from WordPress to the fields above') ?></li>
            <li><?= I18N::translate('Fill in the OAuth2 endpoint URLs from WordPress') ?></li>
            <li><?= I18N::translate('Enable Seamless SSO and save settings') ?></li>
            <li><?= I18N::translate('Test by logging out and visiting the site') ?></li>
        </ol>
        <p><strong><?= I18N::translate('For detailed documentation, see README.md in the module directory.') ?></strong></p>
    </div>
</div>
